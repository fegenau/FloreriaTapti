---
import Layout from "../../components/Layout.astro";
import { supabase } from "../../lib/supabase";
// @ts-ignore
import {
  WebpayPlus,
  Options,
  IntegrationApiKeys,
  Environment,
  IntegrationCommerceCodes,
} from "transbank-sdk";

const token = Astro.url.searchParams.get("token_ws");

let status = "error";
let message = "Error en la transacción.";
let orderId = "";

if (token) {
  /*
  try {
    const tx = new WebpayPlus.Transaction(
      new Options(
        IntegrationCommerceCodes.WEBPAY_PLUS,
        IntegrationApiKeys.WEBPAY,
        Environment.Integration
      )
    );

    // Commit the transaction to check status
    const response = await tx.commit(token);

    if (response.status === "AUTHORIZED") {
      status = "success";
      message = "Pago exitoso! Tu suscripción ha sido activada.";
      orderId = response.sessionId; // We stored UUID in sessionId

      // Update Supabase
      const { error } = await supabase
        .from("orders")
        .update({ status: "paid" })
        .eq("id", orderId);

      if (error) console.error("Error updating order:", error);

      // Activate subscription
      await supabase
        .from("subscriptions")
        .update({ is_active: true })
        .eq("order_id", orderId);
    } else {
      status = "failed";
      message = "El pago fue rechazado o anulado.";
    }
  } catch (e) {
    console.error(e);
    message = "Error al confirmar la transacción con Transbank.";
  }
  */
  status = "pending";
  message = "Transacción simulada (Transbank desactivado).";
} else {
  // TBK_TOKEN implies user aborted
  if (Astro.url.searchParams.get("TBK_TOKEN")) {
    status = "aborted";
    message = "Anulaste la compra.";
  }
}
---

<Layout title="Estado del Pago | Tapti">
  <div class="min-h-screen flex items-center justify-center p-4">
    <div
      class="bg-white/10 backdrop-blur-md border border-white/20 p-8 rounded-2xl max-w-md w-full text-center"
    >
      {
        status === "success" ? (
          <div class="text-green-400 mb-4">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-16 w-16 mx-auto mb-2"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
            <h1 class="text-3xl font-bold">¡Pago Exitoso!</h1>
          </div>
        ) : (
          <div class="text-red-400 mb-4">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-16 w-16 mx-auto mb-2"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
            <h1 class="text-3xl font-bold">Algo salió mal</h1>
          </div>
        )
      }

      <p class="text-white/80 text-lg mb-8">{message}</p>

      <a
        href="/catalogo"
        class="bg-honey-bronze-500 hover:bg-honey-bronze-400 text-midnight-violet-950 font-bold py-3 px-8 rounded-full shadow-lg transition-transform hover:scale-105"
      >
        Volver al Catálogo
      </a>
    </div>
  </div>
</Layout>
