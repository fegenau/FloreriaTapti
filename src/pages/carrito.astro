
---
import Layout from "../components/Layout.astro";
---
<Layout title="Carrito — Tapti">
  <section class="max-w-4xl mx-auto px-4 py-12">
    <h1 class="font-serif text-3xl mb-6">Tu Carrito</h1>
    <div id="cartList" class="space-y-4"></div>
    <div class="mt-6 flex items-center justify-between">
      <div class="text-lg">Total: <span id="total">$0</span></div>
      <a id="checkoutBtn" href="#" class="px-6 py-3 rounded-full bg-tapti-gold text-tapti-deep font-medium">Pagar</a>
    </div>
  </section>
  <script>
    const list = document.getElementById('cartList');
    const totalEl = document.getElementById('total');
    const btn = document.getElementById('checkoutBtn');
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    let total = 0;
    list.innerHTML = cart.map((i)=>{
      total += i.price;
      return `<div class="p-4 border border-white/10 rounded-xl flex items-center justify-between">
          <div>
            <div class="font-serif">${i.name} — ${i.size}</div>
            <div class="text-sm opacity-80">${i.comuna ? i.comuna + ' · ' : ''}${i.date || ''}</div>
          </div>
          <div>$${i.price.toLocaleString('es-CL')}</div>
        </div>`;
    }).join('');
    totalEl.textContent = `$${total.toLocaleString('es-CL')}`;
    btn.addEventListener('click', async (e)=>{
      e.preventDefault();
      const res = await fetch('/api/mp/create-preference', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items: cart })
      });
      const data = await res.json();
      if (data.init_point) {
        window.location.href = data.init_point;
      } else {
        alert('No se pudo iniciar el pago');
      }
    });
  </script>
</Layout>
