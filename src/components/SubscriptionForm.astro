---

---

<div
  class="relative bg-white/10 backdrop-blur-md border border-white/20 p-8 rounded-2xl shadow-xl max-w-lg mx-auto overflow-hidden"
>
  <div
    class="absolute -top-10 -right-10 w-32 h-32 bg-purple-500 rounded-full mix-blend-multiply filter blur-2xl opacity-30 animate-blob"
  >
  </div>
  <div
    class="absolute -bottom-10 -left-10 w-32 h-32 bg-pink-500 rounded-full mix-blend-multiply filter blur-2xl opacity-30 animate-blob animation-delay-2000"
  >
  </div>

  <h2 class="text-3xl font-bold text-white mb-6 text-center relative z-10">
    Suscríbete a Tapti
  </h2>

  <form id="subscription-form" class="space-y-6 relative z-10">
    <!-- Nombre -->
    <div>
      <label for="name" class="block text-sm font-medium text-purple-100 mb-1"
        >Nombre Completo</label
      >
      <input
        type="text"
        id="name"
        name="name"
        required
        class="w-full bg-white/5 border border-purple-300/30 rounded-lg px-4 py-3 text-white placeholder-purple-200/50 focus:outline-none focus:ring-2 focus:ring-purple-400 transition-all"
        placeholder="Juan Pérez"
      />
    </div>

    <!-- RUT -->
    <div>
      <label for="rut" class="block text-sm font-medium text-purple-100 mb-1"
        >RUT</label
      >
      <input
        type="text"
        id="rut"
        name="rut"
        required
        class="w-full bg-white/5 border border-purple-300/30 rounded-lg px-4 py-3 text-white placeholder-purple-200/50 focus:outline-none focus:ring-2 focus:ring-purple-400 transition-all"
        placeholder="12.345.678-9"
      />
    </div>

    <!-- Dirección -->
    <div>
      <label
        for="address"
        class="block text-sm font-medium text-purple-100 mb-1"
        >Dirección de Envío</label
      >
      <input
        type="text"
        id="address"
        name="address"
        required
        class="w-full bg-white/5 border border-purple-300/30 rounded-lg px-4 py-3 text-white placeholder-purple-200/50 focus:outline-none focus:ring-2 focus:ring-purple-400 transition-all"
        placeholder="Av. Siempre Viva 742"
      />
    </div>

    <!-- Suscripción -->
    <div>
      <label
        for="duration"
        class="block text-sm font-medium text-purple-100 mb-1"
        >Plan de Suscripción</label
      >
      <select
        id="duration"
        name="duration"
        class="w-full bg-white/5 border border-purple-300/30 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-400 transition-all [&>option]:text-gray-900"
      >
        <option value="15">Cada 15 días</option>
        <option value="30">Cada 30 días</option>
      </select>
    </div>

    <button
      type="submit"
      class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform hover:-translate-y-0.5 transition-all duration-200 flex justify-center items-center gap-2"
    >
      <span>Ir al Pago</span>
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-5 w-5"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
      </svg>
    </button>
  </form>
</div>

<script>
  import { navigate } from "astro:transitions/client";

  const form = document.querySelector("#subscription-form") as HTMLFormElement;
  const addressInput = document.querySelector("#address") as HTMLInputElement;
  const submitBtn = form?.querySelector(
    'button[type="submit"]'
  ) as HTMLButtonElement;

  let isAddressValid = false;

  async function validateAddress() {
    const address = addressInput.value;
    if (address.length < 5) return;

    // Visual feedback "validating..."
    const originalBorder = addressInput.classList.contains("border-red-500")
      ? "border-red-500"
      : "border-purple-300/30";
    addressInput.classList.remove(
      "border-red-500",
      "border-green-500",
      "border-purple-300/30"
    );
    addressInput.classList.add("border-yellow-400");

    try {
      const response = await fetch("/api/validate-address", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ address }),
      });
      const data = await response.json();

      addressInput.classList.remove("border-yellow-400");

      if (data.isValid) {
        addressInput.classList.add("border-green-500");
        isAddressValid = true;
        // Optional: Update with formatted address
        // addressInput.value = data.formattedAddress;
      } else {
        addressInput.classList.add("border-red-500");
        isAddressValid = false;
        alert("Dirección no encontrada. Por favor verifica.");
      }
    } catch (e) {
      console.error(e);
      addressInput.classList.remove("border-yellow-400");
      addressInput.classList.add("border-purple-300/30"); // Reset
    }
  }

  if (addressInput) {
    // Validate on blur
    addressInput.addEventListener("blur", validateAddress);
  }

  if (form) {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!isAddressValid) {
        await validateAddress();
        if (!isAddressValid) return;
      }

      const formData = new FormData(e.target as HTMLFormElement);
      const data = Object.fromEntries(formData);

      // Spinner logic could go here
      submitBtn.textContent = "Procesando...";
      submitBtn.disabled = true;

      try {
        const response = await fetch("/api/orders/create", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        });

        if (response.ok) {
          const result = await response.json();
          // Redirect to Transbank
          if (result.url && result.token) {
            const form = document.createElement("form");
            form.action = result.url;
            form.method = "POST";
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = "token_ws";
            input.value = result.token;
            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
          } else {
            alert("Error: No se recibió URL de pago");
          }
        } else {
          alert("Error al crear la orden. Intente nuevamente.");
        }
      } catch (error) {
        console.error("Error:", error);
        alert("Ocurrió un error inesperado");
      } finally {
        submitBtn.innerHTML = `<span>Ir al Pago</span>
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
      </svg>`;
        submitBtn.disabled = false;
      }
    });
  }
</script>
```
